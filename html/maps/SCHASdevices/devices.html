<!DOCTYPE html>
<html>
    <head>
        <title>SCHAS Data</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="jquery-latest.js"></script> 
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script type="text/javascript" src="jquery.tablesorter.js"></script> 
        <script type="text/javascript" src="sorttables.js"></script> 
        <script src="../../js/config.prod.js"></script>
        <script src="../../js/ajaxutils.js"></script>
        <script src="../../js/generalutils.js"></script>
        <script src="../../js/spatial1.js"></script>
        <script src="../../js/useroptions.js"></script>                
        <script src="./js/highstock.js"></script>
        <script src="./js/highcharts-more.js"></script>
        <script src="./js/modules/exporting.js"></script>
        
    
    </head>
    <body>        
        <div style="width: 100%; overflow: hidden;">
            <div id="dataTable" style="width: 40%; float: left;">
                <div id="table" style="height: 400px; overflow:scroll;">
                    <table align="center" id="data" class="tablesorter" border="1"> 
                        <thead> 
                            <tr> 
                                <th>Last Name</th> 
                                <th>First Name</th> 
                                <th>MobileID</th> 
                                <th>Active</th> 
                                <th>username</th> 
                            </tr> 
                        </thead> 
                        <tbody> 
                            <tr> 
                                <td>Meyers</td> 
                                <td>Wade</td> 
                                <td>a98d0849f9ca66ba</td> 
                                <td>1</td> 
                                <td>Wade</td> 
                            </tr> 
                            <tr> 
                                <td>Narayanappa</td> 
                                <td>Sada</td> 
                                <td>15c0f0958ea64769</td> 
                                <td>0</td> 
                                <td>sada</td> 
                            </tr>   
                            <tr> 
                                <td>Bae</td> 
                                <td>Wan</td> 
                                <td>125cahgq2r2ot234</td> 
                                <td>1</td> 
                                <td>wan</td> 
                            </tr> 
                        </tbody> 
                    </table> 
                </div>
            </div>
            <div id="uploadsFromUserChart" style="width: 35%; display: inline-block;"></div>
            <div id="moreInformation" style="width: 25%; float: right;">
                <form id="profileForm" name="profileForm" method="post" action="">
                    <fieldset>
                        <legend align="center">Personal Information</legend>
                        <p>
                            <label for="fname">First Name</label>
                            <input type="text" id="moreInfoFirstName" name="fname" class="text" size="30" />
                        </p>
                        <p>
                            <label for="lname">Last Name</label>
                            <input type="text" id="moreInfoLastName" name="lname" class="text" size="30" />
                        </p>
                        <p>
                            <label for="cname" >Username</label>
                            <input type="text" id="moreInfoUsername" name="cname" class="text" size="30" data-newAccount = "true"/>
                        </p>
                        <p>
                            <label for="password">Password</label>
                            <input type="text" id="moreInfoPassword" name="password" class="text" size="30" />
                        </p>
                        <p>
                            <label for="createAddress">Address</label>
                            <input type="textarea" id="moreInfoAddress" name="createAddress" class="text"  />
                        </p>
                        <p>
                            <label for="cellphone">Cell Phone</label>
                            <input type="text" id="moreInfoCell" name="cellphone" class="text" size="20" />
                        </p>
                        <p>
                            <label for="mobileid">Mobile id</label>
                            <input type="text" id="moreInfoMobileID" name="mobileid" class="text" size="20" readonly/>
                        </p>
                        <p>
                            <label for="homephone">Home phone</label>
                            <input type="text" id="moreInfoHome" name="homephone" class="text" size="20" />
                        </p>
                        <p>
                            <label for="home_location">Home location</label>
                            <input type="text" id="moreInfoHomeLoc" name="home_location" class="text" size="20" />
                        </p>                        
                        <span id="accountMessage"></span>
                        
                        <p>
                            <button type="button" class="button positive" onclick="update()">                                
                                Update
                            </button>
                        </p>
                    </fieldset>
                </form>                 
            </div>
        </div>
        <div id="activeUsers">            
            <div id="activeUsersChart"></div>
        </div>
        
        <script>
            
            $(document).ready(function() {
                $.ajax({
                    type: "GET",
                    url: config.PROXY2 + config.WEBS + "/aura/webroot/db.jsp?api_key=test&qn=29",
                    contentType: "application/text; charset=utf-8",                   
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        console.log("Data table error: " + XMLHttpRequest+ textStatus+ errorThrown)
                    }, 
                    success: function(data){
                        eval(data);
                        var cols = $rs.colnames;
                        var type = $rs.coltypes;
                        var data = $rs.rows || $rs[Object.keys($rs)[0]];
                        var activeUsersi = cols.indexOf("activeusers");                        
                        var activeData = []
                        var activeDates = []
                        for ( i in data) {
                            activeData[i] = data[i][activeUsersi];   
                            activeDates[i] = data[i][0];
                        }   

                        addChart(activeDates,activeData);
                    } // success
                }); // ajax
            });
            
            function uploadsChartData(mobileid){
                $.ajax({
                    type: "GET",
                    url: config.PROXY2 + config.WEBS + "/aura/webroot/db.jsp?api_key=test&qn=30",
                    contentType: "application/text; charset=utf-8",     
                    data: "mobile_id=" + mobileid,
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        console.log("Data table error: " + XMLHttpRequest+ textStatus+ errorThrown)
                    }, 
                    success: function(data){
                        eval(data);
                        var cols = $rs.colnames;
                        var type = $rs.coltypes;
                        var data = $rs.rows || $rs[Object.keys($rs)[0]];
                        var uploadsi = cols.indexOf("uploads");
                        var datei = cols.indexOf("stored_at");
                        var heartbeatsi = cols.indexOf("heartbeats");
                        var attacksi = cols.indexOf("attacks");
                        var uploadData = []
                        var uploadDates = []
                        var uploadHeartbeats = []
                        var uploadAttacks = []
                        for ( i in data) {
                            uploadData[i] = data[i][uploadsi];   
                            uploadDates[i] = data[i][datei];
                            uploadHeartbeats[i] = data[i][heartbeatsi];
                            uploadAttacks[i]=data[i][attacksi]
                        }   

                        addUploadsChart(uploadDates,uploadData,uploadHeartbeats,uploadAttacks);
                    } // success
                }); // ajax
            }
            
            function addUploadsChart(dates,data,heartbeats,attacks){
                var data2 = [];
                for(var i=0;i<dates.length;i++){
                    data2[i]=[Date.parse(dates[i]),data[i]-heartbeats[i]-attacks[i]];                    
                }
                var heartbeats2 = [];
                for(var i=0;i<dates.length;i++){
                    heartbeats2[i]=[Date.parse(dates[i]),heartbeats[i]];                    
                }
                var attacks2 = [];
                for(var i=0;i<dates.length;i++){
                    attacks2[i]=[Date.parse(dates[i]),attacks[i]];                    
                }
                $('#uploadsFromUserChart').highcharts('StockChart',{
                    chart: {
                        type: 'column'
                    },
                    rangeSelector: {
                        allButtonsEnabled: true,
                        selected: 0
                    },
                    title: {
                        text: 'Uploads per day'
                    },                    
                    xAxis: {
                        //categories: dates,
                        type: 'datetime',
                        title: {
                            text: null
                        }
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'Uploads',
                            align: 'high'
                        },
                        labels: {
                            overflow: 'justify'
                        }
                    },
                    tooltip: {
                        valueSuffix: ' uploads'
                    },
                    plotOptions: {
                        bar: {
                            dataLabels: {
                                enabled: true
                            }
                        },
                        series: {
                            stacking: 'normal'
                        }
                    },                    
                    credits: {
                        enabled: false
                    },
                    series: [{
                        name: 'Location Uploads',
                        data: data2                  
                    },{
                        name: 'Heartbeats',
                        data: heartbeats2             
                    },{
                        name: 'Attacks',
                        data: attacks2             
                    }]
                });         
            }
            
            function addChart(dates,data){
                var data2 = [];
                for(var i=0;i<dates.length;i++){
                    data2[i]=[Date.parse(dates[i]),data[i]];                    
                }
                $('#activeUsersChart').highcharts('StockChart',{
                    chart: {
                        type: 'column'
                    },
                    rangeSelector: {
                        allButtonsEnabled: true,
                        selected: 1
                    },
                    title: {
                        text: 'Active Users'
                    },                    
                    xAxis: {
                        type: 'datetime',
                        //categories: dates,
                        title: {
                            text: null
                        }
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'Active Users',
                            align: 'high'
                        },
                        labels: {
                            overflow: 'justify'
                        }
                    },
                    tooltip: {
                        valueSuffix: ' people'
                    },
                    plotOptions: {
                        bar: {
                            dataLabels: {
                                enabled: true
                            }
                        }
                    },                    
                    credits: {
                        enabled: false
                    },
                    series: [{
                        name: 'Users',
                        data: data2                 
                    }]
                });
            }
            
            function createAccount(){
                var username = $('#moreInfoUsername').val();
                var password = $('#moreInfoPassword').val();                
                var fname = $('#moreInfoFirstName').val();
                var lname = $('#moreInfoLastName').val();
                var address = $('#moreInfoAddress').val();
                var cellphone = $('#moreInfoCell').val();
                var mobileid = $('#moreInfoMobileID').val();
                var homephone = $('#moreInfoHome').val();
                var home_location = $('#moreInfoHomeLoc').val();

                if(username != "" && password != ""){
                    $.ajax({
                        type: "GET",
                        url: config.PROXY2 + config.WEBS + "/aura/webroot/db.jsp?api_key=test&qn=27",
                        contentType: "application/json; charset=utf-8",
                        dataType: "text",
                        // send username and password as parameters to the python script
                        data: "username=" + username + "&password=" + password + "&fname=" + fname+"&lname=" +lname+"&address="+address+"&cellphone="+cellphone+"&mobileid="+mobileid+"&homephone="+homephone+"&home_location="+home_location+"&viewable_mobileid="+mobileid,
                        // script call was *not* successful
                        error: function(XMLHttpRequest, textStatus, errorThrown) {
                            //  $('div#loginResult').text("responseText: " + XMLHttpRequest.responseText
                            console.log( XMLHttpRequest.responseText);   
                        },
                        success: function(data){
                            //$("#moreInfoUsername").attr('readonly', true);
                            document.getElementById('moreInfoUsername').setAttribute("data-newAccount", "false")
                            alert("New Account Created");
                            $('#accountMessage').text("New account created.");

                        }// success
                    });
                    $.ajax({
                        type: "GET",
                        url: config.PROXY2 + config.WEBS + "/aura/webroot/db.jsp?cmd=reload",
                        contentType: "application/text; charset=utf-8",                   
                        error: function(XMLHttpRequest, textStatus, errorThrown) {
                            console.log("Data table error: " + XMLHttpRequest+ textStatus+ errorThrown)
                        }, 
                        success: function(data){
                        } // success
                    }); // ajax
                }
                else{

                    $('#accountMessage').text("Creating an Account requires at least a username and password");
                }
            } 
            
            function update(){
                
                if(document.getElementById('moreInfoUsername').getAttribute("data-newAccount") == "false"){
                    updateAccount();                                
                }else{
                    if($('#moreInfoUsername').val()=="" || $('#moreInfoPassword').val()=="")
                    {
                        $('#accountMessage').text("Creating an Account requires at least a username and password");
                    }
                    else{
                        createAccount();
                    }
                }
            }
            
            function updateAccount(){
                var username = $('#moreInfoUsername').val();
                var password = $('#moreInfoPassword').val();                
                var fname = $('#moreInfoFirstName').val();
                var lname = $('#moreInfoLastName').val();
                var address = $('#moreInfoAddress').val();
                var cellphone = $('#moreInfoCell').val();
                var mobileid = $('#moreInfoMobileID').val();
                var homephone = $('#moreInfoHome').val();
                var home_location = $('#moreInfoHomeLoc').val();
                $.ajax({
                    type: "GET",
                    url: config.PROXY2 + config.WEBS + "/aura/webroot/db.jsp?api_key=test&qn=34",
                    contentType: "application/text; charset=utf-8",
                    dataType: "text",
                    data: "fname=" + fname + "&lname=" + lname+ "&address=" + address+ "&cellphone=" + cellphone+ "&mobileid=" +
                    mobileid+ "&homephone=" + homephone+"&home_location=" + home_location+"&cname=" + username+"&passwd="+password,
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        //  $('div#loginResult').text("responseText: " + XMLHttpRequest.responseText
                        console.log( XMLHttpRequest.responseText);                        
                    }, // error
                    // script call was successful
                    success: function(data){ 
                        alert("Account updated successfully")
                        $('#accountMessage').text("Updated account "+ username);                        
                        
                    } // success
                }); // ajax  
                $.ajax({
                    type: "GET",
                    url: config.PROXY2 + config.WEBS + "/aura/webroot/db.jsp?cmd=reload",
                    contentType: "application/text; charset=utf-8",                   
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        console.log("Data table error: " + XMLHttpRequest+ textStatus+ errorThrown)
                    }, 
                    success: function(data){
                    } // success
                }); // ajax
            }
            
            function moreInformation(fname,lname,mobileID,cname,address,cellphone,homephone,homelocation,passwd){
                $("#moreInfoFirstName").val(fname.replace(null,""));
                $("#moreInfoLastName").val(lname.replace(null,""));
                $("#moreInfoMobileID").val(mobileID.replace(null,""));
                $("#moreInfoUsername").val(cname.replace(null,""));
                $("#moreInfoAddress").val(address.replace(null,""));
                $("#moreInfoCell").val(cellphone.replace(null,""));
                $("#moreInfoHome").val(homephone.replace(null,""));
                $("#moreInfoHomeLoc").val(homelocation.replace(null,""));
                $("#moreInfoPassword").val(passwd.replace(null,""));
                $('#accountMessage').text("");
                if(cname.replace(null,"") == ""){                    
                    //$("#moreInfoUsername").removeAttr('readonly')
                    document.getElementById('moreInfoUsername').setAttribute("data-newAccount", "true")
                }
                else{
                    //$("#moreInfoUsername").attr('readonly', true);
                    document.getElementById('moreInfoUsername').setAttribute("data-newAccount", "false")
                    
                }
            }
                        
            
            function populateTable(data){
                eval(data);
                var cols = $rs.colnames;
                var type = $rs.coltypes;
                var data = $rs.rows || $rs[Object.keys($rs)[0]];
                
                mobileIDi = cols.indexOf("mobile_id");
                fNamei = cols.indexOf("fname");
                lNamei = cols.indexOf("lname");
                cNamei = cols.indexOf("cname");
                addressi = cols.indexOf("address");
                cellphonei = cols.indexOf("cellphone");
                homephonei = cols.indexOf("homephone");
                homelocationi = cols.indexOf("home_location");
                latestUploadi = cols.indexOf("newestupload");
                latestHeartbeati = cols.indexOf("recentheartbeat");
                totalUploadsi = cols.indexOf("numentries");
                passwdi = cols.indexOf("passwd");                                                
                
                
                str = "<thead> <tr> <th>Mobile ID</th> <th>First Name</th> <th>Latest Upload</th> <th>Total Uploads</th> </tr> </thead> <tbody>" ;
                for ( i in data) {
                    d = data [i];
                    str = str+"<tr onClick=\"uploadsChartData('"+d[mobileIDi]+"'); moreInformation('"+d[fNamei]+"','"+d[lNamei]+"','"+d[mobileIDi]+"','"+d[cNamei]+"','"+d[addressi]+"','"+d[cellphonei]+"','"+d[homephonei]+"','"+d[homelocationi]+"','"+d[passwdi]+"');\"> <td>"+d[mobileIDi]+"</td> "+"<td>"+d[fNamei].toString().replace(null,"")+"</td> "+"<td>"+d[latestUploadi]+"</td> "+"<td>"+d[totalUploadsi]+"</td> </tr>";
                }                
                str = str + "</tbody>";
                $("#data").html(str);
                $("#data").tablesorter({
                    headers: {
                        2: { sorter:'customDate' }
                    },
                    sortList: [[2,1]]
                });

            }
            
            function dataQuery(){
                $.ajax({
                    type: "GET",
                    url: config.PROXY2 + config.WEBS + "/aura/webroot/db.jsp?api_key=test&qn=28",
                    contentType: "application/text; charset=utf-8",                   
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        console.log("Data table error: " + XMLHttpRequest+ textStatus+ errorThrown)
                    }, 
                    success: function(data){
                        populateTable(data);
                    } // success
                }); // ajax
            }
        </script>
        
    </body>
</html>
