<!DOCTYPE HTML>
<html>
<head>
    <title>SCHAS Maps</title>
    <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>

    <script src="../js/config.prod.js"></script>
    <script src="../js/ajaxutils.js"></script>
    <script src="../js/generalutils.js"></script>
    <script src="../js/spatial1.js"></script>

    <script src="../js/useroptions.js"></script>
    <script src="Layers.js"></script>
    <script src="os.js"></script>
    <script src="utils.js"></script>
    <script src="citiesLayer.js"></script>
    <script src="stationsLayerVoronoi.js"></script>
    <script src="stationsLayer.js"></script>
    <script src="roadsLayer.js"></script>
    <script src="routeLayer.js"></script>
    <script src="trackLayer.js"></script>
    <script src="syntheticLayer.js"></script>
    <link rel="stylesheet" type="text/css" media="screen, projection"
          href="http://www.blueprintcss.org/blueprint/screen.css" />
    <link rel="stylesheet"  type="text/css" media="screen, projection"
          href="http://www.blueprintcss.org/blueprint/plugins/buttons/screen.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="http://www.blueprintcss.org/blueprint/print.css" />
    <!--[if IE]><link rel="stylesheet" type="text/css" media="screen, projection"
                      href="http://www.blueprintcss.org/blueprint/ie.css"><![endif]-->

    <link rel="stylesheet" type="text/css" href="SCHASstylesheet.css">

    <style type="text/css">
        #loginContent { width: 350px; margin: 100px auto; }
        #profileContent { width: 350px; margin: 100px auto; }
        button[type] { margin: 0.5em 0; }
    </style>
    <script>
        $(function() {
            $( "#tabs" ).tabs();
        });
        $(document).ready(function() {
            init();
            initUserSettings();
        });

        function initUserSettings() { //initialize the control panel settings
            getUserOptions();
            if ( !userOptions )
                userOptions = defaultUserOptions;

            runQuery1(); // load the information
            ControlPanelToggle(userOptions.controlPanel);
            trackLayerUpdate(userOptions.myUserID, false);
            setUserOptions(map);
            $('div#profile').hide();
        }
    </script>

</head>
<body>
<div id="mapdiv"></div>

<script>
    function ControlPanelToggle(onOff) {  //onOff = none, block -> if none ->opens
        d = onOff || document.getElementById('formcontent').style.display;

        if ( d == "none") {
            d = "block";
            userOptions.controlPanel = "none"
        } else {
            d = "none";
            userOptions.controlPanel = "block";
        }
        document.getElementById('formcontent').style.display = d;
    }
</script>
<div id='form'>
    <form name="input" action="javascript: submitform();" method="post">
        <div style="font-variant: small-caps; text-align: right; width: 100%; background-color: grey">
            Control Panel
            <img src="http://www.clker.com/cliparts/O/S/I/l/m/L/minus-sign-subtract-md.png"
                 width="16px" onclick="ControlPanelToggle()" /><hr/>
            <input type="button" value="Save my Options" onclick="saveUserOptions(map)"/>
            <input type="button" value="Set my Options" onclick="setUserOptions(map)"/>
            <hr/>
        </div>
        <div id="formcontent">
            <label for="query">Address/zip :</label>
            <input type="text" id="query" size=50 name="query" value="Menomonie, WI"/>

            <input type="submit" value="Submit"/>
            <br>

            <hr size="1"/>

            <div id="tabs">
                <ul>
                    <li><a href="#tabs-3">Pick/ User</a></li>
                    <li><a href="#tabs-1">Settings</a></li>
                    <li><a href="#tabs-2">Utilities</a></li>

                </ul>
                <div id="tabs-1">

                    <div id="loginContent">
                        <div id="loginResult" style="display:none;">
                        </div>
                        <form id="loginForm" name="loginForm" method="post" action="">
                            <fieldset>
                                <legend>Enter information</legend>
                                <p>
                                    <label for="username">Username</label>
                                    <br />
                                    <input type="text" id="username" name="username" class="text" size="20" />
                                </p>
                                <p>
                                    <label for="password">Password</label>
                                    <br />
                                    <input type="password" id="password" name="password" class="text" size="20" />
                                </p>
                                <p>
                                    <button type="button" class="button positive" onclick="runQuery2();">
                                        <img alt="ok" src=
                                                "http://www.blueprintcss.org/blueprint/plugins/buttons/icons/tick.png" />
                                        Login
                                    </button>
                                </p>
                            </fieldset>
                        </form>
                    </div>

                    <div id="profile">
                        <div id="profileResult" style="display:none;">
                        </div>
                        <form id="profileForm" name="profileForm" method="post" action="">
                            <fieldset>
                                <legend>Update Personal Information</legend>

                                <p>
                                    <label for="fname">First Name</label>
                                    <br />
                                    <input type="text" id="fname" name="fname" class="text" size="30" />
                                </p>
                                <p>
                                    <label for="lname">Last Name</label>
                                    <br />
                                    <input type="text" id="lname" name="lname" class="text" size="30" />
                                </p>
                                <p>
                                    <label for="address">Address</label>
                                    <br />
                                    <input type="textarea" id="address" name="address" class="text"  />
                                </p>
                                <p>
                                    <label for="cellphone">cell phone</label>
                                    <br />
                                    <input type="text" id="cellphone" name="cellphone" class="text" size="20" />
                                </p>
                                <p>
                                    <label for="mobileid">Mobile id</label>
                                    <br />
                                    <input type="text" id="mobileid" name="mobileid" class="text" size="20" />
                                </p>
                                <p>
                                    <label for="homephone">Home phone</label>
                                    <br />
                                    <input type="text" id="homephone" name="homephone" class="text" size="20" />
                                </p>
                                <p>
                                    <label for="home_location">Home location</label>
                                    <br />
                                    <input type="text" id="home_location" name="home_location" class="text" size="20" />
                                </p>


                                <p>
                                    <button type="button" class="button positive" onclick="runQuery3();">
                                        <img alt="ok" src=
                                                "http://www.blueprintcss.org/blueprint/plugins/buttons/icons/tick.png" />
                                        Update
                                    </button>
                                </p>
                            </fieldset>
                        </form>


                    </div>


                </div>
                <div id="tabs-2">
                    <p>Find interesting trajectories - query</p>
                    <input type="button" value="Place Start Node"  onclick="routeLayer.setCanAddStartPoint(true)" />
                    <input type="button" value="Place End Node"  onclick="routeLayer.setCanAddEndPoint(true)" />
                    <input type="button" value="Compute Route" onclick="routeLayer.instance.LayerUpdate()"/>
                </div>
                <div id="tabs-3" style="height:440px;overflow-y:auto;">
                    <p>Pick Users</p>
                </div>

            </div>

            <hr size="1"/>
            <a style="color: white;" href="http://www.geospaces.org">Geospaces SCHAS Maps</a> |
            <div id="coords" style="height: 1.5em; display:inline; text-align: right"></div>
        </div>
    </form>
</div>

<script>
    var userSysId;
    function clearAllMapPopups() {
        while( map.popups.length ) {
            map.removePopup(map.popups[0]);
        }
    }
    function setURL(parms) {
        s = top.window.location.href;
        if (s.lastIndexOf("?") > 0) {
            s = s.substring(a, s.lastIndexOf("?"));
        }
        s= s + "?" + parms;
        top.window.location.href = s;
    }

    function changeTrackLayer(p, updateBounds ) {
        userOptions.myUserID = p;
        trackLayerUpdate(p, true);
    }
    function setUserSessions(text) {
        eval(text);
        //console.log(text);
        var cols = $rs.colnames;
        var type = $rs.coltypes;
        var data = $rs.rows || $rs[Object.keys($rs)[0]];

        str = "";
        mobile_id = "";
        for ( i in data) {
            d = data [i];
            if (mobile_id != d[0]) {
                mobile_id = d[0]
                str = str + "<hr>"
            }

            if ( d[1].indexOf("-") < 0) {
                p = "'mobile_id="+ d[0] + "&session_num=" + d[1] + "'"; // containst mobile_id and session num
            } else {
                p = "'mobile_id="+ d[0] + "&measured_at=" + d[1] + "'"; // containst mobile_id and session num
            }
            s = "changeTrackLayer(" + p + ")";
            a = "<a href=# onclick=" + s + " >" + d[0] + "," + d[1] + "</a><br/>\n"
            str = str  + a;

            if ( i == 0) {
                CURRENT_PARMS = p;
            }


        }
        $("#tabs-3").html(str);
    }


    function runQuery1(divName) {
        url = config.PROXY + "http://www.geospaces.org/aura/webroot/db.jsp?qn=9a"
        url = config.PROXY + "http://www.geospaces.org/aura/webroot/db.jsp?qn=15"
        submitForm({URL: url, fdata: {}, CB: setUserSessions })
    }

    function runQuery2(){ // loginForm is submitted
        var username = $('#username').val(); // get username
        var password = $('#password').val(); // get password
        if (username && password) { // values are not empty
            $.ajax({
                type: "GET",
                url: config.PROXY + "http://www.geospaces.org/aura/webroot/db.jsp?api_key=test&qn=14",
                contentType: "application/json; charset=utf-8",
                dataType: "text",
                // send username and password as parameters to the python script
                data: "cname=" + username + "&passwd=" + password,
                // script call was *not* successful
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    //  $('div#loginResult').text("responseText: " + XMLHttpRequest.responseText
                    console.log( XMLHttpRequest.responseText);
                    $('div#loginResult').text(""
                    + ", textStatus: " + textStatus
                    + ", errorThrown: " + errorThrown);
                    $('div#loginResult').addClass("error");
                }, // error
                // script call was successful
                success: function(data){
                    if (data.error) { // script returned error
                        $('div#loginResult').text("data.error: " + data.error);
                        $('div#loginResult').addClass("error");
                    } // if
                    else { // data recieved
                        eval(data);
                        var data2 = $rs.rows || $rs[Object.keys($rs)[0]];
                        if(data2.length > 0) {
                            $('div#loginContent').hide();
                            $('div#profile').show();
                            $('#profileForm').get(0).reset();

                            for ( i in data2)
                                d = data2 [i];
                             userSysId = d[0];
                            $("#fname").val(d[1].replace(null,""));
                            $("#lname").val(d[2].replace(null,""));
                            $("#address").val(d[3].replace(null,""));
                            $("#cellphone").val(d[4].replace(null,""));
                            $("#mobileid").val(d[5].replace(null,""));
                            $("#homephone").val(d[7].replace(null,""));
                            $("#home_location").val(d[9].replace(null,""));

                          //  ["userid","fname","lname","cname","address","cellphone","mobileid","homephone","passwd","home_location"]
                        }
                        else{

                            $('div#loginResult').text("Login Failed: " );
                            $('div#loginResult').addClass("error");
                        }
                    }
                } // success
            }); // ajax
        } // if
        else {
            $('div#loginResult').text("Please enter username and password");
            $('div#loginResult').addClass("error");
        } // else
        $('div#loginResult').fadeIn();
        return false;
    }

    function runQuery3(){ // profileForm is submitted

        var fname = $('#fname').val(); // get username
        var lname = $('#lname').val();
        var address = $('#address').val();
        var cellphone = $('#cellphone').val();
        var mobileid = $('#mobileid').val();
        var homephone = $('#homephone').val();
        var home_location = $('#home_location').val();


     ///   var sqlQuerytoUpdate = "update public.user set lname='"+lname+"' , fname='" + fname+ "' , address='" + address+ "', cellphone='" + cellphone+ "', mobileid='" + mobileid+ "', homephone='" + homephone+ "', home_location='" + home_location+ "'where userid ="+userSysId;

        if (lname && fname) { // values are not empty
            $.ajax({
                type: "GET",
                url: config.PROXY + "http://www.geospaces.org/aura/webroot/db.jsp?api_key=test&qn=16",
                contentType: "application/text; charset=utf-8",
                dataType: "text",
                data: "fname=" + fname + "&lname=" + lname+ "&address=" + address+ "&passwd=" + cellphone+ "&cellphone=" +
                mobileid+ "&mobileid=" + homephone+"&home_location=" + home_location+"&userId=" + userSysId,
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    //  $('div#loginResult').text("responseText: " + XMLHttpRequest.responseText
                    console.log( XMLHttpRequest.responseText);
                    $('div#profileResult').text(""
                    + ", textStatus: " + textStatus
                    + ", errorThrown: " + errorThrown);
                    $('div#profileResult').addClass("error");
                }, // error
                // script call was successful
                success: function(data){
                    if (data.error) { // script returned error
                        $('div#profileResult').text("data.error: " + data.error);
                        $('div#profileResult').addClass("error");
                    } // if
                    else { // data recieved
                       // eval(data);
                        $('div#profileResult').text("Profile saved");
                        $('div#profileResult').addClass("success");


                    }
                } // success
            }); // ajax
        } // if
        else {
            $('div#profileResult').text("Please enter the required fields");
            $('div#profileResult').addClass("error");
        } // else
        $('div#profileResult').fadeIn();
        return false;
    }

</script>
</body>
</html>